<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mera Telegram Jaisa App</title>
    <style>
        /* Basic Reset & Global Styles */
        *, *::before, *::after { box-sizing: border-box; }
        html { height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body {
            min-height: 100vh; margin: 0;
            background-color: #17212b; /* Dark background for app pages */
            color: #fff;
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* --- PAGE CONTAINERS --- */
        .app-page {
            display: none; 
            flex-direction: column;
            height: 100vh; 
            width: 100%;
            overflow: hidden; 
        }
        .app-page.active {
            display: flex; 
        }

        /* --- AUTH SCREEN (MODIFIED) --- */
        #auth-screen {
            display: flex; 
            flex-direction: column;
            /* justify-content: center; */ /* Removed for stacked forms */
            align-items: center; /* Center forms horizontally */
            height: 100vh; 
            background-color: #0088cc; /* Blue background */
            color: white; 
            padding: 20px;
            overflow-y: auto; /* Allow scrolling if content overflows */
        }
        #auth-screen.hidden { display: none !important; }

        .auth-header { /* Optional header for Auth Screen */
            width: 100%;
            text-align: center;
            padding: 10px 0 0px 0; /* Adjusted padding */
        }
        .auth-header h1 {
            margin: 0 0 20px 0; /* Space below header */
            font-size: 1.8em; 
            font-weight: 500;
        }

        #auth-screen #login-form,
        #auth-screen #signup-form {
            display: flex; 
            flex-direction: column;
            align-items: center; 
            width: 100%;
            max-width: 400px; 
            padding: 0px 20px 20px 20px; /* No top padding, header has bottom margin */
            margin-bottom: 10px; 
        }
        /* #signup-form has no .hidden class in HTML by default */

        #auth-screen h2 {
            margin-bottom: 20px;
            font-weight: 500;
            color: white;
            text-align: center; /* Center form titles */
        }
        #auth-screen input {
            width: 100%; 
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #fff;
            color: #333;
            font-size: 1em;
        }
        #auth-screen button {
            width: 100%; 
            padding: 12px 25px;
            background-color: #00629e;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 1em;
            font-weight: 500;
        }
        #auth-screen button:hover {
            background-color: #004c7a;
        }
        #auth-screen .toggle-form {
            margin-top: 15px;
            color: #f0f0f0;
            text-decoration: underline;
            cursor: pointer;
            text-align: center; 
        }
        #auth-error {
            color: #ffd2d2; 
            margin-top: 10px;
            text-align: center;
            min-height: 1.2em;
            font-weight: 500;
        }


        /* --- SHARED PAGE COMPONENTS (for app pages) --- */
        .page-header {
            background-color: #2b5278; 
            color: white;
            padding: 0 15px;
            height: 56px; 
            display: flex;
            align-items: center;
            flex-shrink: 0; 
        }
        .page-header .icon-btn { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; padding: 8px; line-height: 1; }
        .page-header .title { flex-grow: 1; font-size: 1.2em; font-weight: 500; margin-left: 10px; }
        
        .scrollable-content {
            flex-grow: 1; 
            overflow-y: auto; 
            background-color: #212d3b; 
        }

        /* Chat List Item Styling */
        .chat-list-item { padding: 10px 15px; cursor: pointer; display: flex; align-items: center; position: relative; min-height: 72px; border-bottom: 1px solid #1c2733; }
        .chat-list-item:hover { background-color: #2a3948; }
        .chat-list-item .avatar { width: 50px; height: 50px; border-radius: 50%; background-color: #555; margin-right: 12px; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 1.2em; flex-shrink: 0; color: #fff; }
        .chat-list-item .chat-info { overflow: hidden; flex-grow: 1; padding-right: 70px; }
        .chat-list-item .chat-info.no-meta { padding-right: 15px; }
        .chat-list-item .chat-info .chat-name { font-weight: 500; font-size: 1em; color: #e1e3e5; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 3px; }
        .chat-list-item .chat-info .last-message { font-size: 0.9em; color: #8a99a7; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-list-item .chat-meta { position: absolute; top: 12px; right: 15px; text-align: right; font-size: 0.75em; color: #8a99a7; display: flex; flex-direction: column; align-items: flex-end; }
        .chat-list-item .timestamp { margin-bottom: 5px; }
        .chat-list-item .unread-badge { background-color: #4d91cc; color: white; font-size: 0.7em; padding: 3px 7px; border-radius: 10px; font-weight: 500; min-width: 20px; text-align: center; }

        #new-chat-fab-page { 
            position: fixed; 
            bottom: 25px;
            right: 25px;
            background-color: #5288c1; color: white; width: 56px; height: 56px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 24px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); cursor: pointer; z-index: 100; border: none;
        }
        #new-chat-fab-page.hidden { display: none !important; }

        /* --- ACTIVE CHAT PAGE --- */
        .messages-container { 
            padding: 15px; display: flex; flex-direction: column;
        }
        .message { margin-bottom: 8px; padding: 7px 12px; border-radius: 12px; max-width: 70%; word-wrap: break-word; line-height: 1.4; font-size: 0.95em; }
        .my-message { background-color: #2b5278; align-self: flex-end; margin-left: auto; color: #e5eff8; }
        .other-message { background-color: #26303c; align-self: flex-start; color: #d5dde3; }
        .message .sender-name { font-size: 0.85em; color: #6ca9de; margin-bottom: 3px; font-weight: 500; }
        .my-message .sender-name { display: none; }
        .message .message-time { font-size: 0.7em; color: #707e8c; text-align: right; margin-top: 4px; }
        .my-message .message-time { color: #8ab8e0; }

        .chat-input-area-page {
            display: flex; padding: 8px 12px; background-color: #212d3b; 
            border-top: 1px solid #0f1a25; flex-shrink: 0; align-items: center;
            min-height: 50px;
        }
        #message-input-page { 
            flex-grow: 1; padding: 10px 15px; border: none; border-radius: 20px;
            margin-right: 10px; outline: none; background-color: #17212b;
            color: #cdd3d8; font-size: 0.95em;
        }
        #send-button-page { 
            background-color: #5288c1; color: white; border: none; border-radius: 50%;
            cursor: pointer; width: 40px; height: 40px; display: flex;
            align-items: center; justify-content: center; font-size: 1.2em;
        }
    </style>
</head>
<body>

    <div id="auth-screen"> <!-- Initially visible -->
        <div class="auth-header">
            <h1>Mera Telegram Jaisa App</h1>
        </div>
        <div id="login-form"> <!-- No hidden class -->
            <h2>Login</h2>
            <input type="email" id="login-email" placeholder="Email">
            <input type="password" id="login-password" placeholder="Password">
            <button id="login-button">Login</button>
            <!-- The p.toggle-form elements are now just visual, JS for them is removed -->
            <p class="toggle-form" data-form="signup-form">Don't have an account? Sign Up</p>
        </div>
        <div id="signup-form"> <!-- No hidden class -->
            <h2>Sign Up</h2>
            <input type="text" id="signup-display-name" placeholder="Display Name (e.g. Jade)">
            <input type="email" id="signup-email" placeholder="Email (e.g. jass@gmail.com)">
            <input type="password" id="signup-password" placeholder="Password">
            <button id="signup-button">Sign Up</button>
            <p class="toggle-form" data-form="login-form">Already have an account? Login</p>
        </div>
        <p id="auth-error"></p>
    </div>

    <div id="page-chat-list" class="app-page"> <!-- Initially hidden by .app-page style -->
        <header class="page-header">
            <button class="icon-btn" id="main-menu-btn">‚ò∞</button>
            <span class="title">Telegram</span>
            <button class="icon-btn" id="search-chats-btn">üîç</button>
        </header>
        <div class="scrollable-content" id="chat-list-container-page"></div>
        <button id="new-chat-fab-page" title="New Chat" class="hidden">‚úé</button>
    </div>

    <div id="page-contacts-select" class="app-page">
        <header class="page-header">
            <button class="icon-btn" id="back-from-contacts-btn">‚Üê</button>
            <span class="title">New Message</span>
        </header>
        <div class="scrollable-content" id="contacts-list-container-page"></div>
    </div>

    <div id="page-active-chat" class="app-page">
        <header class="page-header">
            <button class="icon-btn" id="back-from-chat-btn">‚Üê</button>
            <span class="title" id="active-chat-name-page">Chat Name</span>
            <button class="icon-btn" id="chat-options-btn">‚ãÆ</button>
        </header>
        <div class="scrollable-content messages-container" id="messages-container-page"></div>
        <div class="chat-input-area-page">
            <input type="text" id="message-input-page" placeholder="Type a message...">
            <button id="send-button-page">‚û¢</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDK5_blHE_dw63DhFBNAKmcRNepFxnYq5E", // YOUR KEY
            authDomain: "instagram-f0352.firebaseapp.com",
            projectId: "instagram-f0352",
            storageBucket: "instagram-f0352.firebasestorage.app",
            messagingSenderId: "961783441132",
            appId: "1:961783441132:web:7cfc0dff1f22efa75ee7c9",
            measurementId: "G-YS3TPDZWGW"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // DOM Elements - Auth
        const authScreenEl = document.getElementById('auth-screen');
        // const loginFormEl = document.getElementById('login-form'); // Not needed for toggling anymore
        // const signupFormEl = document.getElementById('signup-form'); // Not needed for toggling anymore
        const authErrorEl = document.getElementById('auth-error');
        const signupDisplayNameInput = document.getElementById('signup-display-name');
        const signupEmailInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        // const toggleFormLinks = document.querySelectorAll('.toggle-form'); // Not used for toggling now

        // DOM Elements - Pages
        const pageChatList = document.getElementById('page-chat-list');
        const pageContactsSelect = document.getElementById('page-contacts-select');
        const pageActiveChat = document.getElementById('page-active-chat');

        // DOM Elements - Chat List Page
        const chatListContainerPage = document.getElementById('chat-list-container-page');
        const newChatFabPage = document.getElementById('new-chat-fab-page');
        const mainMenuBtn = document.getElementById('main-menu-btn');
        const searchChatsBtn = document.getElementById('search-chats-btn');

        // DOM Elements - Contacts Select Page
        const contactsListContainerPage = document.getElementById('contacts-list-container-page');
        const backFromContactsBtn = document.getElementById('back-from-contacts-btn');

        // DOM Elements - Active Chat Page
        const activeChatNamePage = document.getElementById('active-chat-name-page');
        const messagesContainerPage = document.getElementById('messages-container-page');
        const messageInputPage = document.getElementById('message-input-page');
        const sendButtonPage = document.getElementById('send-button-page');
        const backFromChatBtn = document.getElementById('back-from-chat-btn');
        const chatOptionsBtn = document.getElementById('chat-options-btn');

        let currentUser = null;
        let currentChatPartner = null;
        let activeChatId = null;
        let messagesListener = null; // Will store the callback function for messages
        let currentChatMessagesRef = null; // Will store the Firebase ref for current messages
        let userChatsListener = null;

        function showPage(pageId) {
            [pageChatList, pageContactsSelect, pageActiveChat].forEach(page => {
                page.classList.remove('active');
            });
            authScreenEl.classList.add('hidden'); 

            if (pageId === 'auth-screen') {
                authScreenEl.classList.remove('hidden');
                // authScreenEl.classList.add('active'); // Not needed as it's not an .app-page
            } else {
                const pageToShow = document.getElementById(pageId);
                if (pageToShow) {
                    pageToShow.classList.add('active');
                }
            }
            if (pageId === 'page-chat-list' && currentUser) {
                newChatFabPage.classList.remove('hidden');
            } else {
                newChatFabPage.classList.add('hidden');
            }
        }
        
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = { uid: user.uid, email: user.email };
                db.ref('users/' + user.uid + '/profile/displayName').once('value').then(snapshot => {
                    currentUser.displayName = snapshot.val() || user.email.split('@')[0];
                });
                showPage('page-chat-list');
                loadUserChats();
            } else {
                if (currentChatMessagesRef && messagesListener) {
                     currentChatMessagesRef.off('child_added', messagesListener);
                }
                if (userChatsListener) userChatsListener.off();
                currentUser = null; currentChatPartner = null; activeChatId = null;
                messagesListener = null; currentChatMessagesRef = null; userChatsListener = null;
                
                showPage('auth-screen');
                chatListContainerPage.innerHTML = '';
                contactsListContainerPage.innerHTML = '';
                messagesContainerPage.innerHTML = '';
                authErrorEl.textContent = '';
                // Reset form fields if they exist (check for null if elements are removed)
                if(document.getElementById('login-form')) document.getElementById('login-form').reset(); 
                if(document.getElementById('signup-form')) document.getElementById('signup-form').reset();
            }
        });
        
        // Removed toggleFormLinks event listener as forms are always visible on auth screen.
        
        document.getElementById('signup-button').addEventListener('click', () => {
            const email = signupEmailInput.value;
            const password = signupPasswordInput.value;
            const displayName = signupDisplayNameInput.value.trim();
            if (!displayName) { authErrorEl.textContent = "Display Name is required."; return; }
            authErrorEl.textContent = '';
            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    const userToUpdate = userCredential.user;
                    return db.ref('users/' + userToUpdate.uid + '/profile').set({
                        email: userToUpdate.email, displayName: displayName, createdAt: firebase.database.ServerValue.TIMESTAMP
                    });
                }).catch(error => authErrorEl.textContent = error.message);
        });

        document.getElementById('login-button').addEventListener('click', () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            authErrorEl.textContent = '';
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => authErrorEl.textContent = error.message);
        });

        mainMenuBtn.addEventListener('click', () => {
            if (confirm("Logout?")) { auth.signOut(); }
        });
        searchChatsBtn.addEventListener('click', () => alert("Search chats - not implemented"));
        chatOptionsBtn.addEventListener('click', () => alert("Chat options - not implemented"));

        newChatFabPage.addEventListener('click', () => {
            showPage('page-contacts-select');
            loadUsersForNewChat();
        });
        backFromContactsBtn.addEventListener('click', () => showPage('page-chat-list'));
        
        backFromChatBtn.addEventListener('click', () => {
            if (currentChatMessagesRef && messagesListener) {
                 currentChatMessagesRef.off('child_added', messagesListener);
                 messagesListener = null;
                 currentChatMessagesRef = null;
            }
            activeChatId = null; // Clear active chat ID
            currentChatPartner = null; // Clear current partner
            showPage('page-chat-list');
        });

        sendButtonPage.addEventListener('click', sendMessageToActiveChatPage);
        messageInputPage.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessageToActiveChatPage();
            }
        });

        function getChatId(uid1, uid2) { return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`; }

        function loadUserChats() {
            // ... (Copy the full function from the previous response, it's correct)
            if (!currentUser) return;
            if (userChatsListener) userChatsListener.off(); // Detach old listener if any

            const userChatsRef = db.ref('userChats/' + currentUser.uid).orderByChild('timestamp');
            userChatsListener = userChatsRef; // Store the ref itself

            userChatsRef.on('value', snapshot => {
                const chatListItemsPromises = [];
                if (!snapshot.exists() || snapshot.numChildren() === 0) {
                    chatListContainerPage.innerHTML = `<p style="padding:20px; text-align:center; color:#8a99a7;">No chats yet. Tap ‚úé to start one!</p>`;
                    return;
                }
                snapshot.forEach(childSnapshot => {
                    const chatData = childSnapshot.val();
                    const chatPartnerUid = childSnapshot.key;
                    chatListItemsPromises.push(
                        db.ref('users/' + chatPartnerUid + '/profile').once('value').then(profileSnap => {
                            const partnerProfile = profileSnap.val();
                            if (partnerProfile) {
                                return {
                                    partnerUid: chatPartnerUid,
                                    partnerDisplayName: partnerProfile.displayName || partnerProfile.email.split('@')[0],
                                    partnerEmail: partnerProfile.email,
                                    lastMessage: chatData.lastMessage || "...",
                                    timestamp: chatData.timestamp,
                                    unreadCount: chatData.unreadCount || 0
                                };
                            }
                            return null;
                        }).catch(e => { console.warn("Error fetching profile for", chatPartnerUid, e); return null; })
                    );
                });

                Promise.all(chatListItemsPromises)
                .then(resolvedChatItems => {
                    chatListContainerPage.innerHTML = ''; // Clear before rendering
                    const validItems = resolvedChatItems.filter(item => item !== null);
                    validItems.sort((a, b) => b.timestamp - a.timestamp); // Newest first
                    
                    if (validItems.length === 0) {
                        // This case might be hit if profiles couldn't be fetched but snapshot had children
                        chatListContainerPage.innerHTML = `<p style="padding:20px; text-align:center; color:#8a99a7;">No chats found or error loading details.</p>`;
                    } else { 
                        validItems.forEach(chatInfo => renderChatListItemPage(chatInfo)); 
                    }
                });
            }, error => {
                console.error("Error loading user chats:", error);
                chatListContainerPage.innerHTML = `<p style="padding:20px; text-align:center; color:red;">Error loading chats.</p>`;
            });
        }

        function renderChatListItemPage(chatInfo) {
            // ... (Copy the full function from the previous response)
            const item = document.createElement('div');
            item.classList.add('chat-list-item');
            item.dataset.partnerUid = chatInfo.partnerUid;

            const avatar = document.createElement('div');
            avatar.classList.add('avatar');
            avatar.textContent = chatInfo.partnerDisplayName.substring(0,1).toUpperCase();
            
            const infoDiv = document.createElement('div');
            infoDiv.classList.add('chat-info');
            const nameEl = document.createElement('div');
            nameEl.classList.add('chat-name');
            nameEl.textContent = chatInfo.partnerDisplayName;
            const lastMsgEl = document.createElement('div');
            lastMsgEl.classList.add('last-message');
            lastMsgEl.textContent = chatInfo.lastMessage;

            infoDiv.appendChild(nameEl);
            infoDiv.appendChild(lastMsgEl);

            const metaDiv = document.createElement('div');
            metaDiv.classList.add('chat-meta');
            const timeEl = document.createElement('span');
            timeEl.classList.add('timestamp');
            timeEl.textContent = chatInfo.timestamp ? new Date(chatInfo.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
            metaDiv.appendChild(timeEl);

            if (chatInfo.unreadCount > 0) {
                const unreadEl = document.createElement('span');
                unreadEl.classList.add('unread-badge');
                unreadEl.textContent = chatInfo.unreadCount > 99 ? "99+" : chatInfo.unreadCount;
                metaDiv.appendChild(unreadEl);
            }
            
            item.appendChild(avatar);
            item.appendChild(infoDiv);
            item.appendChild(metaDiv);

            item.addEventListener('click', () => {
                currentChatPartner = { uid: chatInfo.partnerUid, displayName: chatInfo.partnerDisplayName, email: chatInfo.partnerEmail };
                if (currentUser && chatInfo.partnerUid) {
                    db.ref('userChats/' + currentUser.uid + '/' + chatInfo.partnerUid + '/unreadCount').set(0);
                }
                openChatPage(currentChatPartner);
            });
            chatListContainerPage.appendChild(item);
        }
        
        function loadUsersForNewChat() {
            // ... (Copy the full function from the previous response)
            if (!currentUser) return;
            contactsListContainerPage.innerHTML = `<p style="padding:15px; text-align:center; color:#8a99a7;">Loading users...</p>`;
            db.ref('users').once('value').then(snapshot => {
                contactsListContainerPage.innerHTML = ''; // Clear loading message
                if (!snapshot.exists()) { 
                    contactsListContainerPage.innerHTML = `<p style="padding:15px; text-align:center; color:#8a99a7;">No other users found.</p>`;
                    return; 
                }
                let usersFound = 0;
                snapshot.forEach(childSnapshot => {
                    const uid = childSnapshot.key;
                    const profile = childSnapshot.val().profile;
                    if (uid !== currentUser.uid && profile) { // Don't list self, ensure profile exists
                        usersFound++;
                        renderContactItemPage(profile, uid);
                    }
                });
                if (usersFound === 0) { 
                    contactsListContainerPage.innerHTML = `<p style="padding:15px; text-align:center; color:#8a99a7;">No other users to chat with.</p>`;
                }
            }).catch(error => {
                console.error("Error loading users for new chat:", error);
                contactsListContainerPage.innerHTML = `<p style="padding:15px; text-align:center; color:red;">Error loading users.</p>`;
            });
        }

        function renderContactItemPage(profile, uid) {
            // ... (Copy the full function from the previous response)
            const item = document.createElement('div');
            item.classList.add('chat-list-item');
            
            const avatar = document.createElement('div');
            avatar.classList.add('avatar');
            avatar.textContent = (profile.displayName || profile.email.split('@')[0]).substring(0,1).toUpperCase();

            const infoDiv = document.createElement('div');
            infoDiv.classList.add('chat-info');
            infoDiv.classList.add('no-meta'); 
            
            const nameEl = document.createElement('div');
            nameEl.classList.add('chat-name');
            nameEl.textContent = profile.displayName || profile.email.split('@')[0];
            
            const emailEl = document.createElement('div'); 
            emailEl.classList.add('last-message');
            emailEl.textContent = profile.email;
            
            infoDiv.appendChild(nameEl);
            infoDiv.appendChild(emailEl);
            item.appendChild(avatar);
            item.appendChild(infoDiv);

            item.addEventListener('click', () => {
                const targetUser = { uid: uid, displayName: profile.displayName || profile.email.split('@')[0], email: profile.email };
                startNewChatWithUserAndGoToChatPage(targetUser);
            });
            contactsListContainerPage.appendChild(item);
        }

        function openChatPage(partner) {
            // ... (Copy the full function from the previous response, ensure listener detachment is correct)
            if (!currentUser || !partner) return; // Added a check for partner
            
            // Detach listener for the PREVIOUS chat if it exists
            if (currentChatMessagesRef && messagesListener) {
                 currentChatMessagesRef.off('child_added', messagesListener);
            }

            activeChatId = getChatId(currentUser.uid, partner.uid);
            currentChatPartner = partner;

            activeChatNamePage.textContent = partner.displayName;
            messagesContainerPage.innerHTML = ''; // Clear previous messages

            showPage('page-active-chat');

            currentChatMessagesRef = db.ref('chats/' + activeChatId + '/messages').orderByChild('timestamp').limitToLast(50);
            
            const messageCallback = snapshot => { // Define callback locally
                displayMessagePage(snapshot.val());
            };
            messagesListener = messageCallback; // Store this specific callback
            currentChatMessagesRef.on('child_added', messagesListener); // Attach with this specific callback
        }
        
        function displayMessagePage(message) {
            // ... (Copy the full function from the previous response)
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message');
            const senderNameSpan = document.createElement('div');
            senderNameSpan.classList.add('sender-name');
            const messageTextSpan = document.createElement('div');
            messageTextSpan.classList.add('message-text');
            messageTextSpan.textContent = message.text; // Ensure message.text exists
            const timeSpan = document.createElement('div');
            timeSpan.classList.add('message-time');
            timeSpan.textContent = message.timestamp ? new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'sending...';

            if (currentUser && message.senderId === currentUser.uid) {
                msgDiv.classList.add('my-message');
            } else {
                msgDiv.classList.add('other-message');
                senderNameSpan.textContent = message.senderDisplayName || (message.senderEmail ? message.senderEmail.split('@')[0] : 'User');
                msgDiv.appendChild(senderNameSpan);
            }
            msgDiv.appendChild(messageTextSpan);
            msgDiv.appendChild(timeSpan);
            messagesContainerPage.appendChild(msgDiv);
            if(messagesContainerPage.scrollHeight > messagesContainerPage.clientHeight) {
                 messagesContainerPage.scrollTop = messagesContainerPage.scrollHeight;
            }
        }

        function sendMessageToActiveChatPage() {
            // ... (Copy the full function from the previous response)
            const text = messageInputPage.value.trim();
            if (!text || !currentUser || !currentChatPartner || !activeChatId) return;
            const messageData = {
                text: text, senderId: currentUser.uid, senderEmail: currentUser.email,
                senderDisplayName: currentUser.displayName, receiverId: currentChatPartner.uid, 
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            db.ref('chats/' + activeChatId + '/messages').push(messageData);
            const membersUpdate = {};
            membersUpdate[currentUser.uid] = true; membersUpdate[currentChatPartner.uid] = true;
            db.ref('chats/' + activeChatId + '/members').update(membersUpdate);
            
            const chatSummary = {
                lastMessage: text, timestamp: firebase.database.ServerValue.TIMESTAMP,
            };
            db.ref('userChats/' + currentUser.uid + '/' + currentChatPartner.uid).update({...chatSummary, unreadCount: 0 });
            const partnerChatRef = db.ref('userChats/' + currentChatPartner.uid + '/' + currentUser.uid);
            partnerChatRef.update(chatSummary); 
            partnerChatRef.child('unreadCount').set(firebase.database.ServerValue.increment(1)); 

            messageInputPage.value = '';
        }

        function startNewChatWithUserAndGoToChatPage(partner) {
            // ... (Copy the full function from the previous response)
            if (!currentUser || !partner ) return; // Added check for partner
            const tempActiveChatId = getChatId(currentUser.uid, partner.uid);
            
            const userChatRefCurrentUser = db.ref('userChats/' + currentUser.uid + '/' + partner.uid);
            userChatRefCurrentUser.once('value', snapshot => {
                if (!snapshot.exists()) {
                    const chatSummary = { lastMessage: "Chat started", timestamp: firebase.database.ServerValue.TIMESTAMP, unreadCount: 0 };
                    db.ref('userChats/' + currentUser.uid + '/' + partner.uid).set(chatSummary);
                    db.ref('userChats/' + partner.uid + '/' + currentUser.uid).set({...chatSummary, unreadCount: 0 });
                }
                // These are now set globally before calling openChatPage
                // currentChatPartner = partner; 
                // activeChatId = tempActiveChatId;
                openChatPage(partner); // partner already contains all necessary info
            });
        }

    </script>
</body>
</html>